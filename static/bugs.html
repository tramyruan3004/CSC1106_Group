<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Bugs</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

  <!-- üåê Navbar -->
  <nav class="bg-indigo-700 text-white px-6 py-3 shadow">
    <div class="flex justify-between items-center">
      <div class="font-bold text-lg">üêû BugTracker</div>
      <div class="space-x-4 flex items-center" id="nav-links">
        <a href="dashboard.html" class="hover:underline">Dashboard</a>
        <a href="bugs.html" class="hover:underline font-semibold">Bugs</a>
        <a href="projects.html" class="hover:underline">Projects</a>
        <a href="assign.html" class="hover:underline">Assign</a>
        <!-- Users tab dynamically added below if admin -->
        <button onclick="logout()"
          class="ml-4 bg-white text-indigo-700 font-semibold px-3 py-1 rounded hover:bg-gray-100">Logout</button>
      </div>
    </div>
  </nav>

  <!-- üìã Bug Management -->
  <div class="p-6">
    <h1 class="text-2xl font-bold mb-4 text-indigo-600">Bug Management</h1>

    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <!-- Bug Creation -->
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-2">Create New Bug</h2>
        <input id="title" class="w-full p-2 border mb-2" placeholder="Title" />
        <textarea id="description" class="w-full p-2 border mb-2" placeholder="Description"></textarea>
        <input id="reported_by" class="w-full p-2 border mb-2" placeholder="Reported By" />
        <input id="bug_type" class="w-full p-2 border mb-2" placeholder="Bug Type" />
        <input id="severity" class="w-full p-2 border mb-2" placeholder="Severity (low, medium, high)" />
        <input id="project_id" class="w-full p-2 border mb-2" placeholder="Project ID" />
        <button onclick="createBug()" class="bg-green-500 text-white px-4 py-2 rounded">Create</button>
      </div>

      <!-- Bug List -->
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-2">View All Bugs</h2>
        <button onclick="fetchBugs()" class="bg-blue-500 text-white px-4 py-2 rounded mb-3">Fetch Bugs</button>
        <div id="bugList" class="space-y-3 max-h-96 overflow-auto"></div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    // Parse JWT and inject admin-only "Users" tab
    const payload = (() => {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch {
        return {};
      }
    })();
    const role = payload.role || "";

    if (role === "admin") {
      const usersTab = document.createElement("a");
      usersTab.href = "users.html";
      usersTab.textContent = "Users";
      usersTab.className = "hover:underline";
      document.getElementById("nav-links").prepend(usersTab);
    }

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "login.html";
    }

    async function createBug() {
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const reported_by = document.getElementById("reported_by").value.trim();
      const bug_type = document.getElementById("bug_type").value.trim();
      const severity = document.getElementById("severity").value.trim();
      const project_id = document.getElementById("project_id").value.trim();

      if (!title || !description || !reported_by || !bug_type || !severity || !project_id) {
        alert("All fields are required.");
        return;
      }

      try {
        const res = await fetch("/bugs/new", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            title,
            description,
            reported_by,
            bug_type,
            severity,
            project_id
          })
        });

        if (!res.ok) {
          const err = await res.text();
          throw new Error(err);
        }

        const result = await res.json();
        alert("Bug created: " + JSON.stringify(result));
        fetchBugs();
      } catch (err) {
        alert("Error creating bug: " + err.message);
      }
    }

    async function fetchBugs() {
      const res = await fetch("/bugs", {
        headers: { "Authorization": "Bearer " + token }
      });
      const bugs = await res.json();
      const container = document.getElementById("bugList");
      container.innerHTML = "";

      bugs.forEach(bug => {
        const item = document.createElement("div");
        item.className = "bg-white p-4 rounded shadow";

        item.innerHTML = `
    <p><strong>ID:</strong> ${bug.bug_id}</p>
    <p><strong>Title:</strong> ${bug.title}</p>
    <p><strong>Severity:</strong> ${bug.severity}</p>
    <p><strong>Status:</strong> ${bug.progress_status}</p>
    <p><strong>Project ID:</strong> ${bug.project_id || 'N/A'}</p>
    <button onclick="viewBug(${bug.bug_id})" class="mt-2 bg-indigo-600 text-white px-3 py-1 rounded">View</button>
  `;

        container.appendChild(item);
      });
    }

    function viewBug(id) {
      window.location.href = `bug_detail.html?bug_id=${id}`;
    }
  </script>
</body>

</html>